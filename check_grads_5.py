#!/usr/bin/env python3
import torch, torch.nn.functional as F, time
from transformers import AutoModelForCausalLM, AutoTokenizer

MODEL  = "Qwen/Qwen3-0.6B-Base"
SEQ    = 4096
BATCH  = 1
CHUNK  = 128
DEVICE = "cuda"
DTYPE  = torch.bfloat16
torch.manual_seed(0)

tok = AutoTokenizer.from_pretrained(MODEL)
model = AutoModelForCausalLM.from_pretrained(
    MODEL, torch_dtype=DTYPE, device_map={"": DEVICE})
model.eval().requires_grad_(True)

text = ["Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world.Hello world. Hello world. Hello world. Hello world. Hello world. Hello world. Hello world.Hello world. Hello world."] * BATCH
enc  = tok(text, return_tensors="pt", padding="longest", max_length=SEQ, truncation=True).to(DEVICE)
print(len(enc.input_ids[0]))
input()
def vram(): return torch.cuda.max_memory_allocated() / 1e6

def one_pass(mode="full", chunk=None):
    torch.cuda.empty_cache()
    torch.cuda.reset_peak_memory_stats()
    model.zero_grad(set_to_none=True)

    if mode == "full":
        out = model(enc.input_ids, use_cache=False)
        loss = F.cross_entropy(out.logits[:, :-1].reshape(-1, out.logits.size(-1)),
                               enc.input_ids[:, 1:].reshape(-1))
        loss.backward()

    elif mode == "chunked":
        ids = enc.input_ids
        for st in range(0, ids.size(1)-1, chunk):
            ed = min(st+chunk, ids.size(1))
            if st == 0:
                chunk_ids = ids[:, st:ed]
                pos = torch.arange(ed, device=DEVICE).unsqueeze(0)
                out = model(chunk_ids, use_cache=False, position_ids=pos)
            else:
                with torch.no_grad():
                    pkv = model(ids[:, :st], use_cache=True).past_key_values
                chunk_ids = ids[:, st:ed]
                pos = torch.arange(st, ed, device=DEVICE).unsqueeze(0)
                out = model(chunk_ids, past_key_values=pkv, use_cache=True,
                            position_ids=pos)

            logits = out.logits[:, :-1]
            tgt = ids[:, st+1:ed]
            loss = F.cross_entropy(logits.reshape(-1, logits.size(-1)),
                                   tgt.reshape(-1))
            loss.backward()

    elif mode == "checkpoint":
        model.gradient_checkpointing_enable()
        model.enable_input_require_grads()
        out = model(enc.input_ids, use_cache=False)
        loss = F.cross_entropy(out.logits[:, :-1].reshape(-1, out.logits.size(-1)),
                               enc.input_ids[:, 1:].reshape(-1))
        loss.backward()
        model.gradient_checkpointing_disable()

    return vram()

# Run all three modes
print("\n▶ FULL")
t0 = time.time(); full_vram = one_pass("full"); t1 = time.time()
print(f"  peak VRAM: {full_vram:.1f} MB   time: {t1 - t0:.2f}s")

print("\n▶ CHUNKED no-grad prefix")
t2 = time.time(); chunk_vram = one_pass("chunked", chunk=CHUNK); t3 = time.time()
print(f"  peak VRAM: {chunk_vram:.1f} MB   time: {t3 - t2:.2f}s")

print("\n▶ ACTIVATION CHECKPOINTING")
t4 = time.time(); chk_vram = one_pass("checkpoint"); t5 = time.time()
print(f"  peak VRAM: {chk_vram:.1f} MB   time: {t5 - t4:.2f}s")
